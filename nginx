#!/bin/bash

# Install Nginx (jika belum terinstall)
sudo apt-get update
sudo apt-get install -y nginx

# Path ke file konfigurasi Nginx
nginx_conf="/etc/nginx/nginx.conf"

# URL untuk forward ke server mining pool
mining_pool_url="tcp://de.pyrin.herominers.com:1177"

# Buat konfigurasi Nginx
cat <<EOL > $nginx_conf
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    log_format  main  '\$remote_addr - \$remote_user [\$time_local] "\$request" '
                      '\$status \$body_bytes_sent "\$http_referer" '
                      '"\$http_user_agent" "\$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    server {
        listen 80;
        server_name localhost;

        location / {
            proxy_pass $mining_pool_url;
            proxy_http_version 1.1;
            proxy_set_header Upgrade \$http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host \$host;
            proxy_cache_bypass \$http_upgrade;
        }
    }
}
EOL

# Restart Nginx untuk menerapkan konfigurasi baru
sudo systemctl restart nginx

# Tampilkan pesan bahwa konfigurasi Nginx telah diatur
echo "Konfigurasi Nginx telah diatur untuk melakukan forwarding ke $mining_pool_url."
